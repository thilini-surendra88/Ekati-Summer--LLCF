---
title: Observed and Predicted LLCF Water Quality and Water Levels
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: 
    keep_tex: false
  html_document:
    df_print: paged
    
header-includes:
- \usepackage{placeins}
- \usepackage{setspace}
- \usepackage{chngcntr}
- \onehalfspacing
- \counterwithin{figure}{section}
- \counterwithin{table}{section}
- \usepackage{fancyhdr}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}

- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \pagestyle{fancy}
- \fancyhead{}
- \renewcommand{\headrulewidth}{0pt}
- \fancyfoot[C]{\thepage}   
---

<!--- Comment: - \usepackage[table]{xcolor} doesn't work anymore @!!@. -->







```{r setup, results="hide", echo=FALSE, message=FALSE, warning=FALSE}


# remove any old objects and start with a clean slate
rm(list = ls())

dataDir <- file.path('Data')

##### Global variables #####
source('Graphs_for_LLCF_Update.R')

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(scipen=3)###prevent scientific notation on figures

pacman::p_load(here,zoo,MASS,fBasics,akima,plotrix,ggplot2,dplyr,scales,formattable,kableExtra,reshape,xtable,openxlsx, readxl, knitr, lubridate, tinytex)
 #XLConnect


library(dplyr, warn.conflicts = FALSE)
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)




```


```{r Reading data files, results= "asis"}

##### Global variables #####
# UPDATE DATAFILE WITH CURRENT YEAR
### Must be in month/day/year format####
### To do:

### 1. Update param.list for the selected variables

paramin <- file.path(dataDir,'param.list.csv')
param.list <- read.table(paramin,sep=',',header=T)

### 2. Update observed data files- Cell D, Cell E, 1616-30
observedin <- file.path(dataDir,'Observed Data 1998 to 2020.csv')

##TO UPDATE WITH 2019 LLCF PROFILES WHEN THEY ARE COMPLETED

#datain.profile <- read.table(file.path(dataDir,'LLCF Profiles 2019.csv'),sep=',',header=T)##removed July 23 because of calibration issues
#datain.rel <- read.table(file.path(baseDir,'CondPotRel.csv'),sep=',',header=T)## currently using 2015 to 2017 relationship

#Observed values 2017 and 2018
#field <- read.table(file.path(dataDir,'Field Conductivity_2018.csv'),sep=',',header=T)

#LLCFpumping <- read.table(file.path(dataDir,'LLCF Pumping_rev2017.csv'),sep=',',header=T)
#LLCFpump.strategies <-  read.table(file.path(dataDir,'Strategies.csv'),sep=',',header=T)
#LLCFpump.strategies.new <-  read.table(file.path(dataDir,'2018 Strategies_Aug7.csv'),sep=',',header=T)

#LLCFpump.strategies.new <-  read.table(file.path(dataDir,'2019 Strategies_May28.csv'),sep=',',header=T)
#LLCFpump.strategies.new <-  read.table(file.path(dataDir,'2019 Strategies_July16.csv'),sep=',',header=T)

LLCFpump.strategies.2020 <-  read.table(file.path(dataDir,'2020 Strategies_Jul8.csv'),sep=',',header=T)

#eval = FALSE, echo = FALSE


eqc.list <- read.table(file.path(dataDir,'eqc.list.csv'),sep=",",header=T)

benchmarkin <- file.path(dataDir,'benchmark.list.csv')
benchmark.all <- read.table(benchmarkin,sep=",",header=T) ##***need to update for 2018


WL.dir <- here(file.path("Data","Water.Levels2020.xls"))


WL_CellC.masl.a<-read_excel(WL.dir, sheet="CellC.masl.a")
WL_CellD.masl.a<-read_excel(WL.dir, sheet="CellD.masl.a")
WL_CellE.masl.a<-read_excel(WL.dir, sheet="CellE.masl.a")


```



```{r initialize inputs, results="asis"}

##change here for inputs


syear <- 2017
year <- 2020
p <- 1 #potassium
##potassium eqc
param <- as.character(param.list[p,'Variable'])


#k.eqc <- 53
para.eqc <- eqc.list %>% select({{param}}) %>% pull()
  
  
file.upate <- 'Updated July 9, 2020' ##Last file download
observed.date <- as.Date("05/01/2019","%m/%d/%Y")
observed.date.p <- as.character(observed.date)  ##Last day of observed data



CellD.Stations <- c("RW1","LLD01","LLD05","LLD03","LLD04","1616-28A")
##Get current data for Cell D

CellE.Stations <- c("LLE07","LLE03","LLE05","1616-29A")
##Get current data for Cell E

CellE.Stations <- c("161630 (LLCF)")
##Get current data for Cell E


CellC.Stations <- c("1616-26B")
##Get current data for Cell C



Lake.Stations <- c("Leslie","Moose")
##Get current data for lakes

```


```{r Data manipulation, results="asis"}

dataAll <- getData(observedin,param,syear)


create_station_names("Cell D", CellD.Stations)

create_station_names("Cell E", CellE.Stations)


for(station in CellE.Stations){
  assign(paste0('current.date.', '161630'), as.Date(as.integer(Cell.current(dataAll,"161630 (LLCF)",station)[1])))
  assign(paste0('current.',param, '161630'), Cell.current(dataAll,"161630 (LLCF)",station)[2])
  assign(paste0("n.",'161630'), Cell.current(dataAll,"161630 (LLCF)",station)[3])

}


create_station_names("Cell C", CellC.Stations)

create_station_names(NA , Lake.Stations)





```

# 2020 LLCF Predicted Water Levels and Potassium Concentration


The Discharge and pumping scenarios were developed to address the immediate need to lower water levels in Cells D and E and prevent exceedance of the 449.3 metre elevation during freshet next year, with secondary considerations of limiting potential to exceed the high action level for potassium concentrations in Leslie Lake in winter and retaining enough water to support process plant reclaim in 2021 (we assumed plant operation resumes in January 2021 for this modelling exercise). 

Scenarios 1 and 2 consider the same 2020 Discharge volumes, timing and duration, and the same total volume of water transferred from Cell D to Cell E (i.e., 4 Mm^3^). Scenario 1 has the entire 4 Mm^3^ transferred to Cell E over a four week period (through the first week of August), whereas Scenario 2 has 2 Mm^3^ transferred to Cell E during the July Discharge and another 2 Mm^3^ in September. Water management in 2021 is also the same between these two scenarios, maximizing Discharge in July and continuing in August with limited transfers from Cell D totalling 1.5 Mm^3^. 

Both scenarios 1 and 2 are expected to yield enough capacity to maintain water levels below 449.3 in freshet 2021 with average conditions, under the assumption that operations resume in January. Scenario 2 has a more favourable outcome for Leslie Lake potassium concentrations than Scenario 1. 

Scenario 3 was developed from Scenario 2, with Discharge continuing into August in 2020. Year 2 water management assumed July Discharge at the maximum permitted rate until Cell E reaches its minimum level, then continued reduced discharge through August to maintain Cell E at that level, without additional transfers from Cell D (seepage only). This scenario yields lower water levels through freshet 2021 relative to Scenarios 1 and 2, which would help prevent exceedance of the 449.3 metre water level if resumption of operations is delayed beyond January 2021 (a Cell D target elevation of 448 metres in late September is expected to be sufficient to prevent this if operation does not resume before June 2021). However, this scenario yields slightly higher potassium concentrations in Leslie Lake in Year 1 relative to Scenarios 1 and 2 and similar Year 2 concentrations as Scenario 1. Under extreme ice thicknesses, there is higher potential to approach (and perhaps exceed) the high action level for potassium in Year 2.

We are recommending generally following the Scenario 2 approach initially, then updating the model in late July or early August with updated Cell C, D and E concentrations to re-evaluate potential risks of approaching the high action level for potassium in Leslie lake with Discharge in August and September (i.e., a Discharge more consistent with Scenario 3).


Model Assumptions:

- operations resume at the beginning of 2021
- no winter seepage from Cell C to Cell D in both years

Model Uncertainties

- 2019 observed Cell C concentrations were used as 2020 model inputs, which may be conservative for current conditions.
- Rate of concentration reductions in Cell C may be slower than projected - does not account for releases from FPK porewater.


Table 1 provides a summary of the volumes for pumping in Discharge in 2020 and 2021 for each of the three proposed Scenarios. Table 2 provides the projected Leslie Lake concentrations under ice (Potassium Benchmark in Leslie Lake is 64 mg/L)



### Table 1. LLCF Pumping Volumes (Mm^3^):
| Pumped Flow Mm^3^  |Cell E to Leslie|Cell D to Cell E
|---------------------|:--------:|:--------:|
|**2020**|||
|Scenario 1 |5.1|4.0|
|Scenario 2 |5.1|4.0|
|Scenario 3 |6.5|4.0|
|**2021**|||
|Scenario 1 |5.8|1.5|
|Scenario 2 |5.8|1.5|
|Scenario 3 |4.3|0|

### Table 2. Leslie Lake Winter Concentration Projections:
| Ice Thickness  (m)  |1.2|1.5|1.7|
|---------------------|:--------:|:--------:|:--------:|
|**2020/2021**||||
|Scenario 1 [K] (mg/L) |46.6|50.9|54.3|
|Scenario 2 [K] (mg/L) |45.1|49.2|52.5|
|Scenario 3 [K] (mg/L) |47.0|51.3|54.7|
|**2021/2022**||||
|Scenario 1 [K] (mg/L) |49.1|53.6|57.1|
|Scenario 2 [K] (mg/L) |46.8|51.1|54.5|
|Scenario 3 [K] (mg/L) |48.9|53.4|56.9|

\newpage

## Scenario 1:

2020: Transfer of Cell D to Cell E at 1.0 Mm^3^ per week for four weeks beginning July 10, 2020. Discharge at permit limit rates for 20 days in July 2020.

2021: Cell D to Cell E transfers (0.5 Mm^3^ in July and 1.0 Mm^3^ in September) and Discharge to Leslie Lake July to August.


```{r plots scenarios1, results="asis", figure.align = "left", fig.height=10, fig.width=8.5}

## Divide plotting area into 2 plots: with  Legend
layout(matrix(c(1,2,3),3,1,byrow=T),c(5),c(5,5,1))

###Plot 1- Scenario 1- 2020
##############
plot_pumped_volume(2020,'1', 6,para.eqc)

par(mar=c(5,8,2,6))

###Plot 2- Scenario 1- 2021
##############
plot_pumped_volume(2021,'1', 6,para.eqc)

###2. Legend

plot_legends(para.eqc)

```

## Predicted versus Observed


```{r Scenario 1 Water levels, results="asis", figure.align = "left", fig.height=4.5, fig.width=8.5}

####Scenario 1- obs vs pred Water levels
obs_and_pred_WL <- manipulate_data_for_plots('1',year)

##predicted WL
predicted.wl <- obs_and_pred_WL[[1]]

##observed WL for each CEll C,D,E
CellC.masl.a <- obs_and_pred_WL[[2]]
CellD.masl.a <- obs_and_pred_WL[[3]]
CellE.masl.a <- obs_and_pred_WL[[4]]


tc <- nrow(CellC.masl.a)
td <- nrow(CellD.masl.a)
te <- nrow(CellE.masl.a)


######## Scenario 1, water level


plot_observed_vs_predicted(predicted.wl,
                           CellC.masl.a,
                           CellD.masl.a,
                           CellE.masl.a,
                           scenario.num = '1',
                           year,
                           variable = 'Water Level (masl)')

   




```

```{r Scenario 1 Potassium, results="asis",  figure.align = "left", fig.height=4.5, fig.width=9}

##contains obs and pred values
Potassium.data <- manipulate_data_for_Potassium('1', year)



plot_observed_vs_predicted_Potassium(Potassium.data,'1',year,"Total Potassium (mg/L)",para.eqc)

    
   
```


\newpage

## Scenario 2:

2020: Transfer of Cell D to Cell E for two weeks in July and two weeks in September 2020. Discharge at permit limit rates for 20 days in July 2020 (same as Scenario 1).

2021: Cell D to Cell E transfers (0.5 Mm^3^ in July and 1.0 Mm^3^ in September) and Discharge to Leslie Lake July to August.


```{r plots scenarios2, results="asis", figure.align = "left", fig.height=10, fig.width=8.5}

## Divide plotting area into 2 plots: with  Legend
layout(matrix(c(1,2,3),3,1,byrow=T),c(5),c(5,5,1))

###Plot 1- Scenario 2- 2020
##############
plot_pumped_volume(2020,'2', 6,para.eqc)

par(mar=c(5,8,2,6))

###Plot 2- Scenario 2- 2021
##############
plot_pumped_volume(2021,'2', 6,para.eqc)

###2. Legend

plot_legends(para.eqc)

```

## Predicted versus Observed


```{r Scenario 2 Water levels, results="asis", figure.align = "left", fig.height=4.5, fig.width=8.5}

####Scenario 2- obs vs pred Water levels
obs_and_pred_WL <- manipulate_data_for_plots('2',year)

##predicted WL
predicted.wl <- obs_and_pred_WL[[1]]

##observed WL for each CEll C,D,E
CellC.masl.a <- obs_and_pred_WL[[2]]
CellD.masl.a <- obs_and_pred_WL[[3]]
CellE.masl.a <- obs_and_pred_WL[[4]]


tc <- nrow(CellC.masl.a)
td <- nrow(CellD.masl.a)
te <- nrow(CellE.masl.a)


######## Scenario 2, water level

plot_observed_vs_predicted(predicted.wl,
                           CellC.masl.a,
                           CellD.masl.a,
                           CellE.masl.a,
                           scenario.num = '2',
                           year,
                           variable = 'Water Level (masl)')

   




```

```{r Scenario 2 Potassium, results="asis",  figure.align = "left", fig.height=4.5, fig.width=9}

##contains obs and pred values
Potassium.data <- manipulate_data_for_Potassium('2', year)



plot_observed_vs_predicted_Potassium(Potassium.data,'2',year,"Total Potassium (mg/L)",para.eqc)

    
   
```

\newpage

## Scenario 3:

2020: Transfer of Cell D to Cell E for two weeks in July and two weeks in September 2020. Discharge at permit limit rates for 20 days in July and throughout August 2020.

2021: Discharge at permit limit rates for 16 days in July (to minimum Cell E level) and reduced pumping through August. No transfers from Cell D to Cell E.



```{r plots scenarios3, results="asis", figure.align = "left", fig.height=10, fig.width=8.5}

## Divide plotting area into 2 plots: with  Legend
layout(matrix(c(1,2,3),3,1,byrow=T),c(5),c(5,5,1))

###Plot 1- Scenario 3- 2020
##############
plot_pumped_volume(2020,'3', 6,para.eqc)

par(mar=c(5,8,2,6))

###Plot 2- Scenario 3- 2021
##############
plot_pumped_volume(2021,'3', 6,para.eqc)

###2. Legend

plot_legends(para.eqc)

```


## Predicted versus Observed


```{r Scenario 3 Water levels, results="asis", figure.align = "left", fig.height=4.5, fig.width=8.5}

####Scenario 2- obs vs pred Water levels
obs_and_pred_WL <- manipulate_data_for_plots('3',year)

##predicted WL
predicted.wl <- obs_and_pred_WL[[1]]

##observed WL for each CEll C,D,E
CellC.masl.a <- obs_and_pred_WL[[2]]
CellD.masl.a <- obs_and_pred_WL[[3]]
CellE.masl.a <- obs_and_pred_WL[[4]]


tc <- nrow(CellC.masl.a)
td <- nrow(CellD.masl.a)
te <- nrow(CellE.masl.a)


######## Scenario 2, water level

plot_observed_vs_predicted(predicted.wl,
                           CellC.masl.a,
                           CellD.masl.a,
                           CellE.masl.a,
                           scenario.num = '3',
                           year,
                           variable = 'Water Level (masl)')

   




```

```{r Scenario 3 Potassium, results="asis",  figure.align = "left", fig.height=4.5, fig.width=9}

##contains obs and pred values
Potassium.data <- manipulate_data_for_Potassium('3', year)



plot_observed_vs_predicted_Potassium(Potassium.data,'3',year,"Total Potassium (mg/L)",para.eqc)

    
   
```




